











CREATE VIEW [FDV].[VW_F_AVE_Production_Results]
AS

WITH CTE_BUCKET3 AS (
	SELECT 
		PC.CONTRACT								AS CONTRACT
		, PC.PART_NO							AS PART_NO
		, PC.TOP_LEVEL_PART_NO					AS TOP_LEVEL_PART_NO
		, CONCAT(TOP_LEVEL_PART_NO, PC.PART_NO, PC.CONTRACT ) AS PART_COMP_KEY
		, SUM(PC.BUCKET_LEVEL_COST)				AS BUCKET_LEVEL_COST
	FROM			IFS.PART_COST_BUCKET PC
	INNER JOIN		IFS.COST_BUCKET CB
	ON				CB.CONTRACT = PC.CONTRACT
	AND				CB.COST_BUCKET_ID = PC.COST_BUCKET_ID
	AND				CB.ActInd = 'Y'
	WHERE			PC.ActInd = 'Y'
	AND				PC.COST_BUCKET_PUBLIC_TYPE <> 'SALESOH'
	AND				ISNULL(CB.COST_BUCKET_TYPE, 'DUMMY') <> 'BUCKETS'
	AND				PC.COST_SET = '1' 
	AND				PC.BUCKET_LEVEL <> '0'
	GROUP BY 
		PC.CONTRACT
		, PC.PART_NO
		, PC.TOP_LEVEL_PART_NO)
		, CTE_BUCKET5 AS (
	SELECT 
		IPP.CONTRACT							AS CONTRACT
		, IPP.PART_NO							AS PART_NO
		, PCB.TOP_LEVEL_PART_NO					AS TOP_LEVEL_PART_NO
		, PCB.BUCKET_LEVEL_COST					AS BUCKET_LEVEL_COST
		,PCB.PART_COMP_KEY							AS PART_COMP_KEY
	FROM			CTE_BUCKET3 PCB
	INNER JOIN		IFS.INVENTORY_PART IPP
	ON				IPP.CONTRACT = PCB.CONTRACT 
	AND				IPP.PART_NO  = PCB.PART_NO
	AND				IPP.ActInd = 'Y'


) ,  SHOP_ORDER_VARIANCE AS (
	SELECT 
		  SO.[Order Number]					AS ORDER_NO
		, SO.[Release Number]							AS RELEASE_NO
		, SO.[Sequence Number]						AS SEQUENCE_NO
		, SO.[Cost Bucket ID]						AS COST_BUCKET_ID
		, SO.[Cost Bucket Public Type]				AS COST_BUCKET_PUBLIC_TYPE
		, SO.[Part NO]								AS Part_NO
		, SUM(SO.[Level Cost])						AS LEVEL_COST
		, SUM(SO.[Accumalative Costs])						AS ACCUM_COST
	FROM				FDV.VW_D_Shop_Orders  SO
	WHERE				SO.[Cost Bucket ID] = '400' 
	GROUP BY 
		SO.[Order Number]					
		, SO.[Release Number]							
		, SO.[Sequence Number]						
		, SO.[Cost Bucket ID]						
		, SO.[Cost Bucket Public Type]
		, SO.[Part NO]					

	UNION ALL

	SELECT 
		SOC.ORDER_NO							AS ORDER_NO
		, SOC.RELEASE_NO						AS RELEASE_NO
		, SOC.SEQUENCE_NO						AS SEQUENCE_NO
		, SOC.COST_BUCKET_ID					AS COST_BUCKET_ID
		, SOC.COST_BUCKET_PUBLIC_TYPE			AS COST_BUCKET_PUBLIC_TYPE
		, SOC.PART_NO							AS Part_No
		, 0										AS LEVEL_COST
		, 0										AS ACCUM_COST
	FROM				IFS.SHOP_ORDER_COST_BUCKET SOC
	LEFT JOIN			FDV.VW_D_Shop_Orders AC
	ON					AC.[Order Number] = SOC.ORDER_NO
	AND					AC.[Release Number] = SOC.RELEASE_NO
	AND					AC.[Sequence Number]= SOC.SEQUENCE_NO
	WHERE				SOC.ActInd = 'Y'
	AND					SOC.COST_BUCKET_ID = '400'
	AND					AC.[Cost Bucket ID] IS NULL)


SELECT 
	ISNULL(SO.CONTRACT, '-1')					AS [Contract]
	, ISNULL(SO.ORDER_NO, '-1')					AS [Shop Order]
	, ISNULL(CONCAT(SO.ORDER_NO, SO.RELEASE_NO, SO.SEQUENCE_NO, SM.LINE_ITEM_NO), '-1') AS [Shop_Order_ID]
	, ISNULL(SO.PART_NO, '-1')					AS [Part NO]
	, CONVERT(CHAR, SO.CLOSE_DATE, 112)			AS [Date_Key]
	, SO.QTY_COMPLETE							AS [QTY Complete]
	, ISNULL(SM.LINE_ITEM_NO, '-1')				AS [Line Item No]
	, ISNULL(SM.PART_NO , '-1')					AS [Component]
	, SM.QTY_REQUIRED							AS [QTY Required]
	, SM.QTY_ISSUED								AS [QTY Issued]
	, PC.BUCKET_LEVEL_COST						AS [Cost per UOM]
	, SM.QTY_REQUIRED * PC.BUCKET_LEVEL_COST	AS [Cost Estimated]
	, SM.QTY_ISSUED * PC.BUCKET_LEVEL_COST		AS [Cost QTY Issued]
	, (SM.QTY_ISSUED - SM.QTY_REQUIRED ) * PC.BUCKET_LEVEL_COST AS [Cost Variance]
	, (SM.QTY_REQUIRED - SM.QTY_ISSUED) * PC.BUCKET_LEVEL_COST AS [EFF Result]
	, ((SM.QTY_REQUIRED * PC.BUCKET_LEVEL_COST) - (SM.QTY_ISSUED * PC.BUCKET_LEVEL_COST)) / (SM.QTY_REQUIRED * PC.BUCKET_LEVEL_COST) AS [EFF Result Perc]
FROM			IFS.SHOP_ORD SO 
INNER JOIN		IFS.SHOP_MATERIAL_ALLOC SM 
ON				SM.CONTRACT = SO.CONTRACT
AND				SM.ORDER_NO = SO.ORDER_NO
AND				SM.SEQUENCE_NO = SO.SEQUENCE_NO
AND				SM.RELEASE_NO  = SO.RELEASE_NO
AND				SM.ActInd = 'Y'
INNER JOIN		CTE_BUCKET3 PC 
ON				--PC.TOP_LEVEL_PART_NO = SO.PART_NO 
 			PC.PART_COMP_KEY = CONCAT(SO.PART_NO, SM.PART_NO, SO.CONTRACT)
--AND				SM.PART_NO = PC.PART_NO
AND				PC.CONTRACT = SO.CONTRACT 
--AND				PC.PART_NO  = SM.PART_NO
WHERE			SO.ActInd = 'Y'
AND				UPPER(SO.STATE) = 'CLOSED' 
AND				SO.CONTRACT LIKE 'AVE%'
--AND		 ISNULL(SO.ORDER_NO, '-1')	= 'A1000000045'

UNION ALL

SELECT 
	ISNULL(SO.CONTRACT, '-1')					AS [Contract]
	, ISNULL(SO.ORDER_NO, '-1')					AS [Shop Order]
	, ISNULL(CONCAT(SO.ORDER_NO, SO.RELEASE_NO, SO.SEQUENCE_NO, ''), '-1') AS [Shop_Order_ID]
	, ISNULL(SO.PART_NO, '-1')					AS [Part NO]
	, CONVERT(CHAR, SO.CLOSE_DATE, 112)			AS [Close Date]
	, SO.QTY_COMPLETE							AS [QTY Complete]
	, '-1'										AS [Line Item No]
	, ISNULL(COST_BUCKET_PUBLIC_TYPE, '-1')		AS [Component]
	, 0											AS [QTY Required]
	, 0											AS [QTY Issued]
	, 0											AS [Cost per UOM]
	, SOV.LEVEL_COST							AS [Cost Estimated]
	, SOV.ACCUM_COST							AS [Cost QTY Issued]
	, 0											AS [Cost Variance]
	, 0											AS [EFF Result]
	, (SOV.LEVEL_COST - SOV.ACCUM_COST) / SOV.LEVEL_COST AS [EFF Result Perc]
FROM			IFS.SHOP_ORD SO 
INNER JOIN		SHOP_ORDER_VARIANCE SOV 
ON		CONCAT(SO.ORDER_NO, SO.PART_NO, SO.RELEASE_NO, SO.SEQUENCE_NO) = CONCAT(SOV.ORDER_NO, SOV.Part_NO, SOV.RELEASE_NO, SO.SEQUENCE_NO)
INNER JOIN (
			SELECT 
				ITH2.CONTRACT
				, ORDER_NO
				, TRANSACTION_CODE
			FROM			IFS.INVENTORY_TRANSACTION_HIST ITH2  
			INNER JOIN		IFS.MPCCOM_ACCOUNTING MA
			ON				MA.ACCOUNTING_ID = ITH2.ACCOUNTING_ID
			AND				MA.ActInd = 'Y'
			AND				MA.ACCOUNT_NO LIKE '60%'
			WHERE			ITH2.ActInd = 'Y'
			AND				UPPER(ITH2.TRANSACTION_CODE) LIKE 'SOMTRLV-%' 
		) ITH
ON			ITH.ORDER_NO = SO.ORDER_NO 
AND			ITH.CONTRACT = SO.CONTRACT
WHERE		SO.ActInd = 'Y'	
AND			UPPER(SO.STATE) = 'CLOSED' 
AND			UPPER(SO.CONTRACT) LIKE 'AVE%'
AND			UPPER(COST_BUCKET_PUBLIC_TYPE) = 'SUBCONTRACTING COST'

GROUP BY
	ISNULL(SO.CONTRACT, '-1')
	, ISNULL(SO.ORDER_NO, '-1')
	, ISNULL(CONCAT(SO.ORDER_NO, SO.RELEASE_NO, SO.SEQUENCE_NO, ''), '-1')
	, ISNULL(SO.PART_NO, '-1')
	, CONVERT(CHAR, SO.CLOSE_DATE, 112)
	, SO.QTY_COMPLETE
	, ISNULL(COST_BUCKET_PUBLIC_TYPE, '-1')
	, SOV.LEVEL_COST
	, SOV.ACCUM_COST
	, (SOV.LEVEL_COST - SOV.ACCUM_COST) / SOV.LEVEL_COST